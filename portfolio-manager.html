<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Manager | What the Craft</title>
  <link rel="icon" type="image/jpeg" href="logo.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script src="https://www.unpkg.com/@instantdb/core@latest/dist/standalone/index.umd.cjs"></script>
  <style>
    :root {
      --cream: #F7F0E6;
      --warm-bg: #FDF8F2;
      --blush: #F2C4C4;
      --soft-pink: #E8A0A0;
      --sage: #A8C5A0;
      --lavender: #C4B8D9;
      --warm-yellow: #F5D889;
      --peach: #F5C8A8;
      --brown-dark: #4A3728;
      --brown-medium: #6B5344;
      --brown-light: #8B7355;
      --gold: #D4A853;
      --card-bg: #FFFAF4;
      --shadow: rgba(74, 55, 40, 0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--warm-bg);
      color: var(--brown-dark);
      min-height: 100vh;
    }

    /* Header */
    .manager-header {
      background: var(--brown-dark);
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .manager-header .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .manager-header img {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--gold);
    }

    .manager-header h1 {
      font-family: 'Playfair Display', serif;
      color: var(--cream);
      font-size: 1.3rem;
    }

    .manager-header .header-links a {
      color: var(--peach);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 20px;
      transition: color 0.3s;
    }

    .manager-header .header-links a:hover { color: var(--warm-yellow); }

    .status-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-dot.connected { background: var(--sage); }
    .status-dot.disconnected { background: var(--soft-pink); }

    /* Layout */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 20px 80px;
    }

    /* Instructions banner */
    .instructions {
      background: var(--cream);
      border-radius: 16px;
      padding: 24px 28px;
      margin-bottom: 32px;
      border-left: 4px solid var(--warm-yellow);
    }

    .instructions h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--brown-dark);
    }

    .instructions ol {
      padding-left: 20px;
      color: var(--brown-medium);
      line-height: 1.8;
    }

    .instructions strong { color: var(--brown-dark); }

    /* Add project form */
    .add-form {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 4px 24px var(--shadow);
      margin-bottom: 40px;
    }

    .add-form h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      margin-bottom: 24px;
      color: var(--brown-dark);
    }

    .form-row {
      margin-bottom: 20px;
    }

    .form-row label {
      display: block;
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: var(--brown-medium);
    }

    .form-row input,
    .form-row textarea,
    .form-row select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e8ddd0;
      border-radius: 12px;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      color: var(--brown-dark);
      background: #fff;
      transition: border-color 0.3s;
    }

    .form-row input:focus,
    .form-row textarea:focus,
    .form-row select:focus {
      outline: none;
      border-color: var(--soft-pink);
    }

    .form-row textarea {
      height: 80px;
      resize: vertical;
    }

    /* Image drop zone */
    .drop-zone {
      border: 2px dashed #d4c8b8;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fff;
      position: relative;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--soft-pink);
      background: #fff8f8;
    }

    .drop-zone i {
      font-size: 2rem;
      color: var(--blush);
      margin-bottom: 8px;
      display: block;
    }

    .drop-zone p {
      color: var(--brown-light);
      font-size: 0.95rem;
    }

    .drop-zone p strong { color: var(--brown-medium); }

    .drop-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .image-preview {
      display: none;
      margin-top: 12px;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      max-width: 300px;
    }

    .image-preview img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
      border-radius: 12px;
    }

    .image-preview .remove-preview {
      position: absolute;
      top: 8px; right: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      width: 28px; height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-name {
      display: none;
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--sage);
      font-weight: 600;
    }

    .image-name i { margin-right: 4px; }

    /* Buttons */
    .btn {
      padding: 14px 32px;
      border-radius: 50px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }

    .btn-add {
      background: var(--brown-dark);
      color: var(--cream);
      width: 100%;
      margin-top: 8px;
    }

    .btn-add:hover {
      background: var(--brown-medium);
      transform: translateY(-2px);
    }

    .btn-add:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Project list */
    .project-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .project-list-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      color: var(--brown-dark);
    }

    .project-count {
      background: var(--blush);
      color: var(--brown-dark);
      padding: 4px 14px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .project-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 40px;
    }

    .project-item {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 2px 16px var(--shadow);
      display: flex;
      overflow: hidden;
      transition: transform 0.2s;
    }

    .project-item:hover {
      transform: translateY(-2px);
    }

    .project-item img {
      width: 140px;
      height: 120px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .project-item-body {
      padding: 16px 20px;
      flex: 1;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .project-item-info {
      flex: 1;
    }

    .project-item-info h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.05rem;
      color: var(--brown-dark);
      margin-bottom: 4px;
    }

    .project-item-info p {
      color: var(--brown-light);
      font-size: 0.85rem;
      line-height: 1.5;
      margin-bottom: 6px;
    }

    .project-item .category-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--brown-dark);
    }

    .cat-classroom { background: var(--soft-pink); }
    .cat-party { background: var(--lavender); }
    .cat-custom { background: var(--sage); }
    .cat-showers { background: var(--blush); }
    .cat-holiday { background: var(--warm-yellow); }
    .cat-corporate { background: var(--peach); }
    .cat-baskets { background: #C4D9C8; }
    .cat-decor { background: #D9CEB8; }
    .cat-other { background: var(--blush); }

    .project-item .delete-btn {
      background: none;
      border: none;
      color: var(--brown-light);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .project-item .delete-btn:hover {
      color: #c0392b;
      background: #fdeaea;
    }

    .empty-list {
      text-align: center;
      padding: 48px 20px;
      color: var(--brown-light);
    }

    .empty-list i {
      font-size: 2.5rem;
      color: var(--blush);
      margin-bottom: 12px;
    }

    .empty-list h3 {
      font-family: 'Playfair Display', serif;
      color: var(--brown-dark);
      margin-bottom: 6px;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--brown-dark);
      color: var(--cream);
      padding: 14px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      z-index: 100;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .toast.show { transform: translateX(0); }

    .toast i { margin-right: 8px; }

    /* Loading spinner */
    .loading {
      text-align: center;
      padding: 48px 20px;
    }

    .loading .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--cream);
      border-top-color: var(--soft-pink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading p {
      color: var(--brown-light);
      font-weight: 600;
    }

    /* Auth gate */
    .auth-gate {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: var(--warm-bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-box {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 48px 40px;
      box-shadow: 0 8px 40px var(--shadow);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .auth-box img {
      width: 64px; height: 64px;
      border-radius: 50%;
      border: 3px solid var(--warm-yellow);
      margin-bottom: 20px;
    }

    .auth-box h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      color: var(--brown-dark);
      margin-bottom: 8px;
    }

    .auth-box p {
      color: var(--brown-light);
      font-size: 0.95rem;
      margin-bottom: 24px;
    }

    .auth-box p strong {
      color: var(--brown-dark);
    }

    .auth-box input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e8ddd0;
      border-radius: 12px;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      color: var(--brown-dark);
      text-align: center;
      margin-bottom: 16px;
      transition: border-color 0.3s;
    }

    .auth-box input:focus {
      outline: none;
      border-color: var(--soft-pink);
    }

    .auth-box .error-msg {
      color: #c0392b;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: -8px;
      margin-bottom: 12px;
      display: none;
    }

    .auth-box button {
      width: 100%;
      padding: 14px;
      background: var(--brown-dark);
      color: var(--cream);
      border: none;
      border-radius: 50px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-box button:hover {
      background: var(--brown-medium);
      transform: translateY(-2px);
    }

    .auth-box button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .auth-box .back-link {
      display: inline-block;
      margin-top: 12px;
      color: var(--brown-light);
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: underline;
    }

    .auth-box .back-link:hover {
      color: var(--soft-pink);
    }

    .sign-out-btn {
      background: none;
      border: none;
      color: var(--peach);
      font-family: 'Nunito', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 20px;
      transition: color 0.3s;
    }

    .sign-out-btn:hover { color: var(--warm-yellow); }

    /* Tab bar */
    .tab-bar {
      display: flex;
      gap: 0;
      margin-bottom: 32px;
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 12px var(--shadow);
    }

    .tab-btn {
      flex: 1;
      padding: 16px 24px;
      background: transparent;
      border: none;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      color: var(--brown-light);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
      color: var(--brown-dark);
      background: var(--cream);
    }

    .tab-btn.active {
      color: var(--brown-dark);
      border-bottom-color: var(--soft-pink);
      background: var(--cream);
    }

    .tab-btn .badge {
      background: var(--soft-pink);
      color: #fff;
      padding: 2px 10px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
    }

    .tab-btn.active .badge {
      background: var(--brown-dark);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Inquiry cards */
    .inquiry-item {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 2px 16px var(--shadow);
      padding: 24px;
      margin-bottom: 16px;
      transition: transform 0.2s;
      position: relative;
    }

    .inquiry-item:hover {
      transform: translateY(-2px);
    }

    .inquiry-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .inquiry-header h3 {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      color: var(--brown-dark);
    }

    .inquiry-header .inquiry-email {
      color: var(--brown-light);
      font-size: 0.85rem;
    }

    .inquiry-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
    }

    .inquiry-meta .meta-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      background: var(--cream);
      color: var(--brown-medium);
    }

    .inquiry-meta .meta-tag i {
      font-size: 0.75rem;
      color: var(--brown-light);
    }

    .inquiry-message {
      color: var(--brown-medium);
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 16px;
      padding: 14px 16px;
      background: var(--cream);
      border-radius: 12px;
      border-left: 3px solid var(--blush);
    }

    .inquiry-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .inquiry-timestamp {
      font-size: 0.8rem;
      color: var(--brown-light);
    }

    .inquiry-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .status-select {
      padding: 6px 14px;
      border: 2px solid #e8ddd0;
      border-radius: 50px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--brown-dark);
      background: #fff;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .status-select:focus {
      outline: none;
      border-color: var(--soft-pink);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .status-new { background: var(--soft-pink); color: #fff; }
    .status-replied { background: var(--warm-yellow); color: var(--brown-dark); }
    .status-done { background: var(--sage); color: #fff; }

    .inquiry-delete-btn {
      background: none;
      border: none;
      color: var(--brown-light);
      font-size: 1rem;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .inquiry-delete-btn:hover {
      color: #c0392b;
      background: #fdeaea;
    }

    .empty-inquiries {
      text-align: center;
      padding: 48px 20px;
      color: var(--brown-light);
    }

    .empty-inquiries i {
      font-size: 2.5rem;
      color: var(--blush);
      margin-bottom: 12px;
    }

    .empty-inquiries h3 {
      font-family: 'Playfair Display', serif;
      color: var(--brown-dark);
      margin-bottom: 6px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .manager-header {
        padding: 16px 20px;
      }

      .container { padding: 20px 16px 40px; }

      .add-form { padding: 24px 20px; }

      .project-item {
        flex-direction: column;
      }

      .project-item img {
        width: 100%;
        height: 160px;
      }

      .project-item-body {
        padding: 12px 16px;
      }

      .inquiry-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

  <!-- Auth Gate -->
  <div class="auth-gate" id="authGate">
    <div class="auth-box">
      <img src="logo.jpg" alt="What the Craft">
      <h2>Portfolio Manager</h2>

      <!-- Step 1: Email -->
      <div id="emailStep">
        <p>Enter your email to get a login code.</p>
        <input type="email" id="emailInput" placeholder="ali@whatthecraft.com" autocomplete="email" value="derek.bobola@gmail.com">
        <div class="error-msg" id="emailError"></div>
        <button id="sendCodeBtn">Send Code</button>
      </div>

      <!-- Step 2: Code -->
      <div id="codeStep" style="display:none;">
        <p>We sent a code to <strong id="sentEmailDisplay"></strong></p>
        <input type="text" id="codeInput" placeholder="Enter 6-digit code" autocomplete="one-time-code">
        <div class="error-msg" id="codeError"></div>
        <button id="verifyCodeBtn">Verify & Log In</button>
        <span class="back-link" id="backToEmail">Use a different email</span>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="manager-header">
    <div class="logo-area">
      <img src="logo.jpg" alt="What the Craft">
      <h1>Portfolio Manager</h1>
    </div>
    <div class="header-links">
      <span id="statusIndicator"><span class="status-dot disconnected"></span>Connecting...</span>
      <a href="portfolio.html" target="_blank"><i class="fa-solid fa-eye"></i> View Portfolio</a>
      <a href="index.html"><i class="fa-solid fa-house"></i> Main Site</a>
      <button class="sign-out-btn" id="signOutBtn" style="display:none;" onclick="db.auth.signOut()"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</button>
    </div>
  </div>

  <div class="container">

    <!-- Tab Bar -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="projects" id="projectsTab">
        <i class="fa-solid fa-images"></i> Projects
      </button>
      <button class="tab-btn" data-tab="inquiries" id="inquiriesTab">
        <i class="fa-solid fa-envelope"></i> Inquiries <span class="badge" id="inquiryBadge">0</span>
      </button>
    </div>

    <!-- Projects Tab -->
    <div class="tab-content active" id="projectsContent">

    <!-- Instructions -->
    <div class="instructions">
      <h2><i class="fa-solid fa-circle-info"></i> How This Works</h2>
      <ol>
        <li><strong>Pick a photo</strong> and fill in the details below</li>
        <li>Click <strong>"Add Project"</strong> and it saves to the cloud instantly</li>
        <li>That's it! Your portfolio page updates automatically</li>
      </ol>
    </div>

    <!-- Add Form -->
    <div class="add-form">
      <h2><i class="fa-solid fa-plus"></i> Add New Project</h2>

      <div class="form-row">
        <label for="projectTitle">Project Title</label>
        <input type="text" id="projectTitle" placeholder="e.g. Spring Teacher Appreciation Baskets">
      </div>

      <div class="form-row">
        <label for="projectDesc">Short Description</label>
        <textarea id="projectDesc" placeholder="e.g. Custom gift baskets with personalized tags for a class of 24 teachers."></textarea>
      </div>

      <div class="form-row">
        <label for="projectCategory">Category</label>
        <select id="projectCategory">
          <option value="Classroom & Teacher Gifts">Classroom & Teacher Gifts</option>
          <option value="Party Styling">Party Styling</option>
          <option value="Custom Projects">Custom Projects</option>
          <option value="Baby & Bridal Showers">Baby & Bridal Showers</option>
          <option value="Holiday & Seasonal">Holiday & Seasonal</option>
          <option value="Corporate & Events">Corporate & Events</option>
          <option value="Gift Baskets">Gift Baskets</option>
          <option value="Home Decor">Home Decor</option>
          <option value="__custom__">+ Create My Own...</option>
        </select>
        <div class="custom-category" id="customCategory" style="display:none; margin-top: 10px;">
          <input type="text" id="customCategoryInput" placeholder="Type your custom category name">
        </div>
      </div>

      <div class="form-row">
        <label>Project Photo</label>
        <div class="drop-zone" id="dropZone">
          <input type="file" accept="image/*" id="imageInput">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          <p><strong>Click to pick a photo</strong> or drag & drop it here</p>
        </div>
        <div class="image-preview" id="imagePreview">
          <img id="previewImg" src="" alt="Preview">
          <button class="remove-preview" id="removePreview">&times;</button>
        </div>
        <div class="image-name" id="imageName">
          <i class="fa-solid fa-check-circle"></i> <span id="imageFileName"></span>
        </div>
      </div>

      <button class="btn btn-add" id="addBtn" disabled>Add Project</button>
    </div>

    <!-- Project List -->
    <div class="project-list-header">
      <h2>Your Projects</h2>
      <span class="project-count" id="projectCount">0 projects</span>
    </div>

    <div class="project-list" id="projectList">
      <div class="loading" id="loadingState">
        <div class="spinner"></div>
        <p>Loading projects...</p>
      </div>
    </div>

    </div><!-- end projectsContent -->

    <!-- Inquiries Tab -->
    <div class="tab-content" id="inquiriesContent">
      <div class="project-list-header">
        <h2>Customer Inquiries</h2>
        <span class="project-count" id="inquiryCount">0 inquiries</span>
      </div>
      <div id="inquiryList">
        <div class="loading" id="inquiryLoading">
          <div class="spinner"></div>
          <p>Loading inquiries...</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ---- InstantDB Setup ----
    const { init, id: genId } = instant;
    const APP_ID = 'cb0b4fa6-26e4-4b9c-b3c2-29afcbe14890';
    const db = init({ appId: APP_ID });

    // ---- Auth Gate ----
    const authGate = document.getElementById('authGate');
    const emailStep = document.getElementById('emailStep');
    const codeStep = document.getElementById('codeStep');
    const emailInput = document.getElementById('emailInput');
    const emailError = document.getElementById('emailError');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const codeInput = document.getElementById('codeInput');
    const codeError = document.getElementById('codeError');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const sentEmailDisplay = document.getElementById('sentEmailDisplay');
    const backToEmail = document.getElementById('backToEmail');
    const signOutBtn = document.getElementById('signOutBtn');

    let sentEmail = '';

    // Listen for auth state
    db.subscribeAuth((auth) => {
      if (auth.user) {
        // Logged in
        authGate.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
        document.getElementById('statusIndicator').innerHTML =
          '<span class="status-dot connected"></span>' + auth.user.email;
      } else {
        // Not logged in
        authGate.style.display = 'flex';
        signOutBtn.style.display = 'none';
        emailInput.focus();
      }
    });

    // Step 1: Send magic code
    async function sendCode() {
      const email = emailInput.value.trim();
      if (!email) return;

      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'Sending...';
      emailError.style.display = 'none';

      try {
        await db.auth.sendMagicCode({ email });
        sentEmail = email;
        sentEmailDisplay.textContent = email;
        emailStep.style.display = 'none';
        codeStep.style.display = 'block';
        codeInput.focus();
      } catch (err) {
        emailError.textContent = err.body?.message || 'Error sending code';
        emailError.style.display = 'block';
      }

      sendCodeBtn.disabled = false;
      sendCodeBtn.textContent = 'Send Code';
    }

    sendCodeBtn.addEventListener('click', sendCode);
    emailInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendCode();
      emailError.style.display = 'none';
    });

    // Step 2: Verify code
    async function verifyCode() {
      const code = codeInput.value.trim();
      if (!code) return;

      verifyCodeBtn.disabled = true;
      verifyCodeBtn.textContent = 'Verifying...';
      codeError.style.display = 'none';

      try {
        await db.auth.signInWithMagicCode({ email: sentEmail, code });
      } catch (err) {
        codeError.textContent = err.body?.message || 'Invalid code, try again';
        codeError.style.display = 'block';
        codeInput.value = '';
      }

      verifyCodeBtn.disabled = false;
      verifyCodeBtn.textContent = 'Verify & Log In';
    }

    verifyCodeBtn.addEventListener('click', verifyCode);
    codeInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') verifyCode();
      codeError.style.display = 'none';
    });

    // Back to email step
    backToEmail.addEventListener('click', () => {
      codeStep.style.display = 'none';
      emailStep.style.display = 'block';
      codeInput.value = '';
      emailInput.focus();
    });

    let projects = [];
    let imageDataUrl = '';

    // Built-in categories
    const builtInCategories = new Set([
      'Classroom & Teacher Gifts', 'Party Styling', 'Custom Projects',
      'Baby & Bridal Showers', 'Holiday & Seasonal', 'Corporate & Events',
      'Gift Baskets', 'Home Decor'
    ]);

    // Subscribe to real-time data
    db.subscribeQuery({ projects: {} }, (resp) => {
      if (resp.error) {
        console.error('InstantDB error:', resp.error.message);
        document.getElementById('statusIndicator').innerHTML =
          '<span class="status-dot disconnected"></span>Error connecting';
        showToast('<i class="fa-solid fa-triangle-exclamation"></i> Connection error');
        return;
      }
      if (resp.data) {
        projects = resp.data.projects || [];
        // Sort by createdAt descending (newest first)
        projects.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

        document.getElementById('statusIndicator').innerHTML =
          '<span class="status-dot connected"></span>Connected';

        // Add any custom categories to dropdown
        const catSelect = document.getElementById('projectCategory');
        projects.forEach(p => {
          if (p.category && !builtInCategories.has(p.category)) {
            const exists = Array.from(catSelect.options).some(o => o.value === p.category);
            if (!exists) {
              const opt = document.createElement('option');
              opt.value = p.category;
              opt.textContent = p.category;
              catSelect.insertBefore(opt, catSelect.querySelector('[value="__custom__"]'));
              builtInCategories.add(p.category); // prevent re-adding
            }
          }
        });

        renderList();
      }
    });

    // ---- DOM Refs ----
    const titleInput = document.getElementById('projectTitle');
    const descInput = document.getElementById('projectDesc');
    const catSelect = document.getElementById('projectCategory');
    const imageInput = document.getElementById('imageInput');
    const dropZone = document.getElementById('dropZone');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removePreview = document.getElementById('removePreview');
    const imageName = document.getElementById('imageName');
    const imageFileName = document.getElementById('imageFileName');
    const addBtn = document.getElementById('addBtn');
    const projectList = document.getElementById('projectList');
    const projectCount = document.getElementById('projectCount');
    const toast = document.getElementById('toast');
    const customCategoryWrap = document.getElementById('customCategory');
    const customCategoryInput = document.getElementById('customCategoryInput');

    // ---- Custom Category ----
    catSelect.addEventListener('change', () => {
      if (catSelect.value === '__custom__') {
        customCategoryWrap.style.display = 'block';
        customCategoryInput.focus();
      } else {
        customCategoryWrap.style.display = 'none';
        customCategoryInput.value = '';
      }
      checkForm();
    });

    customCategoryInput.addEventListener('input', checkForm);

    function getCategory() {
      if (catSelect.value === '__custom__') return customCategoryInput.value.trim();
      return catSelect.value;
    }

    // ---- Form Validation ----
    function checkForm() {
      const catValid = catSelect.value !== '__custom__' || customCategoryInput.value.trim();
      const valid = titleInput.value.trim() && descInput.value.trim() && imageDataUrl && catValid;
      addBtn.disabled = !valid;
    }

    titleInput.addEventListener('input', checkForm);
    descInput.addEventListener('input', checkForm);

    // ---- Image Handling (compress & store as base64) ----
    function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX = 800;
            let w = img.width, h = img.height;
            if (w > MAX || h > MAX) {
              if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
              else { w = Math.round(w * MAX / h); h = MAX; }
            }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function handleImage(file) {
      if (!file || !file.type.startsWith('image/')) return;
      addBtn.disabled = true;
      imageFileName.textContent = 'Compressing image...';
      imageName.style.display = 'block';

      imageDataUrl = await compressImage(file);

      previewImg.src = imageDataUrl;
      imagePreview.style.display = 'block';
      dropZone.style.display = 'none';
      imageFileName.textContent = file.name;
      checkForm();
    }

    imageInput.addEventListener('change', e => {
      if (e.target.files[0]) handleImage(e.target.files[0]);
    });

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]) handleImage(e.dataTransfer.files[0]);
    });

    removePreview.addEventListener('click', () => {
      imageDataUrl = '';
      previewImg.src = '';
      imagePreview.style.display = 'none';
      dropZone.style.display = 'block';
      imageName.style.display = 'none';
      imageInput.value = '';
      checkForm();
    });

    // ---- Add Project ----
    addBtn.addEventListener('click', async () => {
      if (addBtn.disabled) return;
      addBtn.disabled = true;
      addBtn.textContent = 'Saving...';

      const category = getCategory();

      try {
        await db.transact(
          db.tx.projects[genId()].update({
            title: titleInput.value.trim(),
            description: descInput.value.trim(),
            category: category,
            image: imageDataUrl,
            createdAt: Date.now()
          })
        );

        // If custom category, add to dropdown
        if (catSelect.value === '__custom__' && category) {
          const exists = Array.from(catSelect.options).some(o => o.value === category);
          if (!exists) {
            const opt = document.createElement('option');
            opt.value = category;
            opt.textContent = category;
            catSelect.insertBefore(opt, catSelect.querySelector('[value="__custom__"]'));
          }
        }

        // Reset form
        titleInput.value = '';
        descInput.value = '';
        catSelect.selectedIndex = 0;
        customCategoryWrap.style.display = 'none';
        customCategoryInput.value = '';
        removePreview.click();
        showToast('<i class="fa-solid fa-check"></i> Project added!');
      } catch (err) {
        console.error(err);
        showToast('<i class="fa-solid fa-triangle-exclamation"></i> Error saving');
      }

      addBtn.textContent = 'Add Project';
      checkForm();
    });

    // ---- Delete Project ----
    async function deleteProject(projectId) {
      try {
        await db.transact(db.tx.projects[projectId].delete());
        showToast('<i class="fa-solid fa-trash"></i> Project removed');
      } catch (err) {
        console.error(err);
        showToast('<i class="fa-solid fa-triangle-exclamation"></i> Error deleting');
      }
    }

    // ---- Render List ----
    function renderList() {
      const count = projects.length;
      projectCount.textContent = count + (count === 1 ? ' project' : ' projects');

      if (count === 0) {
        projectList.innerHTML = `
          <div class="empty-list">
            <i class="fa-solid fa-folder-open"></i>
            <h3>No projects yet</h3>
            <p>Use the form above to add your first project!</p>
          </div>`;
        return;
      }

      projectList.innerHTML = projects.map(p => {
        const catClass = p.category && p.category.includes('Teacher') ? 'cat-classroom'
          : p.category && p.category.includes('Party') ? 'cat-party'
          : p.category && p.category.includes('Custom') ? 'cat-custom'
          : p.category && p.category.includes('Shower') ? 'cat-showers'
          : p.category && (p.category.includes('Holiday') || p.category.includes('Seasonal')) ? 'cat-holiday'
          : p.category && (p.category.includes('Corporate') || p.category.includes('Event')) ? 'cat-corporate'
          : p.category && p.category.includes('Basket') ? 'cat-baskets'
          : p.category && p.category.includes('Decor') ? 'cat-decor'
          : 'cat-other';

        const imgSrc = p.image || "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22160%22><rect fill=%22%23F7F0E6%22 width=%22200%22 height=%22160%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%238B7355%22 font-family=%22sans-serif%22 font-size=%2212%22>No image</text></svg>";

        return `
          <div class="project-item">
            <img src="${imgSrc}" alt="${p.title || ''}">
            <div class="project-item-body">
              <div class="project-item-info">
                <h3>${p.title || 'Untitled'}</h3>
                <p>${p.description || ''}</p>
                <span class="category-badge ${catClass}">${p.category || ''}</span>
              </div>
              <button class="delete-btn" onclick="deleteProject('${p.id}')" title="Remove project">
                <i class="fa-solid fa-trash-can"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ---- Toast ----
    function showToast(message) {
      toast.innerHTML = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ---- Tab Switching ----
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab + 'Content').classList.add('active');
      });
    });

    // ---- Inquiries ----
    let inquiries = [];

    db.subscribeQuery({ inquiries: {} }, (resp) => {
      document.getElementById('inquiryLoading').style.display = 'none';

      if (resp.error) {
        console.error('Inquiries error:', resp.error.message);
        return;
      }
      if (resp.data) {
        inquiries = resp.data.inquiries || [];
        inquiries.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        renderInquiries();
      }
    });

    function renderInquiries() {
      const count = inquiries.length;
      const newCount = inquiries.filter(i => i.status === 'new').length;
      document.getElementById('inquiryCount').textContent = count + (count === 1 ? ' inquiry' : ' inquiries');
      document.getElementById('inquiryBadge').textContent = newCount;

      const list = document.getElementById('inquiryList');

      if (count === 0) {
        list.innerHTML = `
          <div class="empty-inquiries">
            <i class="fa-solid fa-inbox"></i>
            <h3>No inquiries yet</h3>
            <p>Customer inquiries from the contact form will appear here.</p>
          </div>`;
        return;
      }

      list.innerHTML = inquiries.map(inq => {
        const date = inq.createdAt ? new Date(inq.createdAt) : null;
        const timeStr = date ? date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';

        const statusClass = inq.status === 'replied' ? 'status-replied' : inq.status === 'done' ? 'status-done' : 'status-new';
        const statusLabel = inq.status === 'replied' ? 'Replied' : inq.status === 'done' ? 'Done' : 'New';

        let metaTags = '';
        if (inq.eventType) metaTags += `<span class="meta-tag"><i class="fa-solid fa-tag"></i> ${inq.eventType}</span>`;
        if (inq.dateNeeded) metaTags += `<span class="meta-tag"><i class="fa-solid fa-calendar"></i> ${inq.dateNeeded}</span>`;
        if (inq.budget) metaTags += `<span class="meta-tag"><i class="fa-solid fa-dollar-sign"></i> ${inq.budget}</span>`;
        if (inq.phone) metaTags += `<span class="meta-tag"><i class="fa-solid fa-phone"></i> ${inq.phone}</span>`;

        return `
          <div class="inquiry-item">
            <div class="inquiry-header">
              <div>
                <h3>${inq.name || 'Unknown'}</h3>
                <div class="inquiry-email">${inq.email || ''}</div>
              </div>
              <span class="status-badge ${statusClass}">${statusLabel}</span>
            </div>
            ${metaTags ? `<div class="inquiry-meta">${metaTags}</div>` : ''}
            <div class="inquiry-message">${inq.message || ''}</div>
            <div class="inquiry-footer">
              <span class="inquiry-timestamp">${timeStr}</span>
              <div class="inquiry-actions">
                <select class="status-select" onchange="updateInquiryStatus('${inq.id}', this.value)">
                  <option value="new" ${inq.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="replied" ${inq.status === 'replied' ? 'selected' : ''}>Replied</option>
                  <option value="done" ${inq.status === 'done' ? 'selected' : ''}>Done</option>
                </select>
                <button class="inquiry-delete-btn" onclick="deleteInquiry('${inq.id}')" title="Delete inquiry">
                  <i class="fa-solid fa-trash-can"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function updateInquiryStatus(inquiryId, status) {
      try {
        await db.transact(db.tx.inquiries[inquiryId].update({ status }));
        showToast('<i class="fa-solid fa-check"></i> Status updated');
      } catch (err) {
        console.error(err);
        showToast('<i class="fa-solid fa-triangle-exclamation"></i> Error updating');
      }
    }

    async function deleteInquiry(inquiryId) {
      try {
        await db.transact(db.tx.inquiries[inquiryId].delete());
        showToast('<i class="fa-solid fa-trash"></i> Inquiry removed');
      } catch (err) {
        console.error(err);
        showToast('<i class="fa-solid fa-triangle-exclamation"></i> Error deleting');
      }
    }
  </script>
</body>
</html>
